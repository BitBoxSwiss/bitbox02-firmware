// Copyright 2019 Shift Cryptosecurity AG
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

#include "common_main.h"
#include "da14531/da14531.h"
#include "da14531/da14531_binary.h"
#include "da14531/da14531_protocol.h"
#include "driver_init.h"
#include "flags.h"
#include "hardfault.h"
#include "memory/memory.h"
#include "memory/memory_shared.h"
#include "memory/memory_spi.h"
#include "memory/spi_mem.h"
#include "platform_init.h"
#include "rust/rust.h"
#include "screen.h"
#include "securechip/securechip.h"
#include "uart.h"
#include "usb/usb.h"
#include "usb/usb_packet.h"
#include "usb/usb_processing.h"
#include "utils_ringbuffer.h"
#include <secp256k1.h>

#include <wally_crypto.h>

#define BUFFER_SIZE_DOWN 1024
#define BUFFER_SIZE_UP 1024

// Size of length prefix (2 bytes).
#define LENSIZE (2)

#define FACTORYSETUP_CMD (HID_VENDOR_FIRST + 0x02) // factory setup commands

// We commit to the BLE firmware hash here to avoid accidentally installing an unexpected firmware.
static const uint8_t _allowed_ble_fw_hash[32] =
    "\xa6\xe8\xda\x32\xe5\x2c\x9b\xdf\xca\xb2\xb8\xbd\x9c\x3f\x5c\xb2\xb8\xa4\xe4\x14\x29\x49\x5e"
    "\x98\x63\xcc\xb0\xd4\x96\xfa\xd5\xe6";

// 65 bytes uncompressed secp256k1 root attestation pubkey.
#define ROOT_PUBKEY_SIZE 65
/* clang-format off */
static uint8_t _root_pubkey_bytes[][ROOT_PUBKEY_SIZE] = {
    {
        0x04, 0x07, 0x4f, 0xf1, 0x27, 0x3b, 0x36, 0xc2, 0x4e, 0x80, 0xfe, 0x3d, 0x59,
        0xe0, 0xe8, 0x97, 0xa8, 0x17, 0x32, 0xd3, 0xf8, 0xe9, 0xcd, 0x07, 0xe1, 0x7e,
        0x9f, 0xc0, 0x63, 0x19, 0xcd, 0x16, 0xb2, 0x5c, 0xf7, 0x42, 0x55, 0x67, 0x44,
        0x77, 0xb3, 0xac, 0x9c, 0xba, 0xc2, 0xd1, 0x2f, 0x0d, 0xc2, 0x7a, 0x66, 0x26,
        0x81, 0xfc, 0xbc, 0x12, 0x95, 0x5b, 0x0b, 0xcc, 0xdc, 0xbb, 0xdc, 0xfd, 0x01,
    },
    {
        0x04, 0x4c, 0x53, 0xa8, 0x4f, 0x41, 0xfa, 0x73, 0x01, 0xb3, 0x78, 0xbb, 0x3c,
        0x26, 0x0f, 0xc9, 0xb2, 0xff, 0x1c, 0xbe, 0xa7, 0xa7, 0x81, 0x81, 0x27, 0x9a,
        0x85, 0x66, 0x79, 0x7a, 0x73, 0x6f, 0x12, 0xce, 0xa2, 0x5f, 0xa2, 0xb1, 0xc2,
        0x7a, 0x84, 0x43, 0x92, 0xfe, 0x9b, 0x37, 0x54, 0x7d, 0xc6, 0xfb, 0xd0, 0x0a,
        0x26, 0x76, 0xb8, 0x16, 0xe7, 0xd2, 0xd3, 0x56, 0x2b, 0xe2, 0xa0, 0xcb, 0xbd,
    },
    {
        0x04, 0xe9, 0xc8, 0xdc, 0x92, 0x97, 0x96, 0xaa, 0xc6, 0x5a, 0xf5, 0x08, 0x4e,
        0xb5, 0x4d, 0xc1, 0xee, 0x48, 0x2d, 0x5e, 0x0b, 0x5c, 0x58, 0xe2, 0xc9, 0x3f,
        0x24, 0x3c, 0x5b, 0x70, 0xb2, 0x15, 0x23, 0x32, 0x4b, 0xdb, 0x78, 0xd7, 0x39,
        0x53, 0x17, 0xda, 0x16, 0x5e, 0xf1, 0x13, 0x88, 0x26, 0xc3, 0xca, 0x3c, 0x91,
        0xca, 0x95, 0xe6, 0xf4, 0x90, 0xc3, 0x40, 0xcf, 0x55, 0x08, 0xa4, 0xa3, 0xec,
    },
    {
        0x04, 0xc2, 0xfb, 0x05, 0x88, 0x9b, 0x9d, 0xff, 0x5a, 0x9f, 0xb2, 0x2a, 0x59,
        0xee, 0x1d, 0x16, 0xbf, 0xc2, 0x86, 0x3f, 0x04, 0x00, 0xdd, 0xcb, 0x69, 0x56,
        0x6e, 0x2a, 0xbe, 0x8a, 0x15, 0xfa, 0x0b, 0xa1, 0x24, 0x02, 0x54, 0xca, 0x45,
        0xaa, 0x31, 0x0d, 0x17, 0x0e, 0x72, 0x4e, 0x13, 0x10, 0xce, 0x5f, 0x61, 0x1c,
        0xad, 0xa7, 0x6c, 0x12, 0xe3, 0xc2, 0x4a, 0x92, 0x6a, 0x39, 0x0c, 0xa4, 0xbe,
    },
    {
        0x04, 0xc4, 0xe8, 0x2d, 0x6d, 0x1b, 0x91, 0xe7, 0x85, 0x3e, 0xba, 0x96, 0xa8,
        0x71, 0xad, 0x31, 0xfc, 0x62, 0x62, 0x0b, 0x82, 0x6b, 0x0b, 0x8a, 0xcf, 0x81,
        0x5c, 0x03, 0xde, 0x31, 0xb7, 0x92, 0xa9, 0x8e, 0x05, 0xbb, 0x34, 0xd3, 0xb9,
        0xe0, 0xdf, 0x10, 0x40, 0xea, 0xc4, 0x85, 0xf0, 0x3f, 0xf8, 0xbb, 0xbf, 0x7a,
        0x85, 0x7e, 0xf1, 0xcf, 0x2a, 0x49, 0xa6, 0x0a, 0xc0, 0x84, 0xef, 0xb8, 0x8f,
    },
    {
        0x04, 0x05, 0x26, 0xf5, 0xb8, 0x34, 0x8a, 0x8d, 0x55, 0xe7, 0xb1, 0xca, 0xc0,
        0x43, 0xce, 0x98, 0xc5, 0x5b, 0xbd, 0xb3, 0x31, 0x1b, 0x4d, 0x1b, 0xb2, 0xd6,
        0x54, 0x28, 0x1e, 0xdf, 0x8a, 0xeb, 0x21, 0xf0, 0x18, 0xfb, 0x02, 0x7a, 0x6b,
        0x08, 0xe4, 0xdd, 0xc6, 0x2c, 0x91, 0x9e, 0x64, 0x86, 0x90, 0x72, 0x2d, 0x00,
        0xc6, 0xf5, 0x4c, 0x66, 0x8c, 0x9b, 0xd8, 0x22, 0x4a, 0x1d, 0x82, 0x42, 0x3a,
    },
    {
        0x04, 0x22, 0x49, 0x1e, 0x19, 0x76, 0x6b, 0xd9, 0x6a, 0x56, 0xe3, 0xf2, 0xf3,
        0x92, 0x6a, 0x6c, 0x57, 0xb8, 0x92, 0x09, 0xff, 0x47, 0xbd, 0x10, 0xe5, 0x23,
        0xb2, 0x23, 0xff, 0x65, 0xab, 0x9a, 0xf1, 0x1c, 0x0a, 0x5f, 0x62, 0xc1, 0x87,
        0x51, 0x4f, 0x21, 0x17, 0xce, 0x77, 0x2d, 0xe9, 0x0f, 0x99, 0x01, 0xee, 0x12,
        0x2a, 0xf7, 0x8e, 0x69, 0xbb, 0xc4, 0xd2, 0x9e, 0xec, 0x81, 0x1b, 0xe8, 0xec,
    },
    {
        0x04, 0x9f, 0x1b, 0x71, 0x80, 0x01, 0x4b, 0x6d, 0xe6, 0x0d, 0x41, 0xf1, 0x6a,
        0x3c, 0x0a, 0x37, 0xb2, 0x01, 0x46, 0x58, 0x5e, 0x48, 0x84, 0x96, 0x02, 0x49,
        0xd3, 0x0f, 0x3c, 0xd6, 0x8c, 0x74, 0xd0, 0x44, 0x20, 0xd0, 0xce, 0xde, 0xf5,
        0x71, 0x9d, 0x6b, 0x15, 0x29, 0xb0, 0x85, 0xec, 0xd5, 0x34, 0xfa, 0x6c, 0x16,
        0x90, 0xbe, 0x5e, 0xb1, 0xb3, 0x33, 0x1b, 0xc5, 0x7b, 0x5d, 0xb2, 0x24, 0xdc,
    },
    {
        0x04, 0xad, 0xaa, 0x01, 0x1a, 0x4c, 0xed, 0x11, 0x31, 0x07, 0x28, 0xab, 0xb6,
        0x4f, 0x09, 0x63, 0x62, 0x67, 0xce, 0x0b, 0x05, 0x78, 0x2d, 0xa6, 0xd3, 0xee,
        0xaf, 0x98, 0x7c, 0xec, 0x7c, 0x64, 0xf2, 0x79, 0xad, 0x55, 0x32, 0x71, 0x84,
        0xf9, 0xe5, 0xb4, 0xa1, 0xe5, 0x30, 0x89, 0xb3, 0x1b, 0xcc, 0x65, 0x03, 0x2d,
        0xad, 0x72, 0x05, 0x32, 0x5f, 0x41, 0xed, 0x3d, 0x9f, 0xdf, 0xba, 0x1f, 0x88,
    },
    {
        0x04, 0x4a, 0x70, 0xe6, 0x63, 0xd7, 0xfe, 0x5f, 0xe0, 0xd4, 0xcb, 0xbb, 0x75,
        0x28, 0x83, 0xe3, 0x52, 0x22, 0xb8, 0xd7, 0xd7, 0xbf, 0xfd, 0xaa, 0x8d, 0x59,
        0x19, 0x95, 0xd1, 0x25, 0x25, 0x28, 0xa4, 0xe9, 0xa3, 0xe4, 0xd5, 0x22, 0x0d,
        0x48, 0x50, 0x21, 0x72, 0x8b, 0x3c, 0xda, 0xd4, 0xfc, 0xcc, 0x68, 0x1a, 0x6d,
        0xde, 0xea, 0x8e, 0x2f, 0x7c, 0x55, 0xb4, 0xac, 0xde, 0x8d, 0x53, 0x57, 0x3d,
    },
    "\x04\xef\x42\xd5\xc7\x42\x54\xdd\x6a\xfb\x36\xec\x75\x20\x68\x25\x2e\xd6\xb6\xe2\x31\xd0\x19\xb0\xdf\xe3\x2e\xe9\xac\x2d\x54\x44\x47\x16\x98\xe0\xce\x76\x26\xe2\xf1\xf6\x26\x6f\x42\xe3\x43\xa2\x0f\xd6\xfe\x2f\xd9\xf2\x06\xe6\x23\xc2\xeb\x6c\x1c\x99\x22\x46\x5d",
    "\x04\x43\x8a\x5d\x3a\x62\x62\xe6\x31\xad\x7a\x59\xae\x9f\xfa\x0e\xe7\x3b\x68\x95\x7c\x4b\x3a\xd4\x6d\x57\x47\xca\xe8\x1b\xeb\x15\xbe\xaf\xd1\xfe\xed\x9c\x50\xfb\xff\x7f\x00\x5a\xe6\x49\x18\x1c\x98\x76\x49\xe1\xb2\x51\xdb\x74\xa0\x52\xfe\xf0\xb6\xe9\x9a\x80\x64",
    "\x04\xd1\x45\xa6\xba\x3b\xf7\x6d\x5d\xb1\xb8\x0d\xbe\xae\xf8\xc6\x6a\x4e\xea\x21\x5d\x1b\x6f\x72\x60\xa0\xb2\xb6\x3f\xd3\x0c\x3f\x4c\x3e\x92\x91\x3a\x6c\xe2\x72\xb3\x6f\xf6\x22\xff\xf6\x4a\x67\xb5\xcf\x8e\xf5\xdb\x64\x5f\x40\x3c\x26\x47\xd4\xc1\x1d\x5f\x96\x8e",
    "\x04\x45\x8f\x68\xed\xde\x1d\x05\x9e\xf2\xcc\xc9\x70\x93\x8c\xd4\x4f\x01\x2d\xa4\xa8\x55\x6f\x35\xf5\xa4\xe1\xdf\x87\x31\x3c\x7a\xdf\xcd\x4f\x22\xe7\x73\x45\xe5\xcc\x90\x0e\xb6\xdd\x48\xaf\x9b\xcb\x42\xbe\xbe\x31\x63\xa7\x9b\x3a\x3a\x3d\x32\xc3\x59\xb5\xc0\x6d",
    "\x04\x56\xbb\x82\xdd\xc8\x4b\xd8\x7d\x0d\x6d\xca\x27\x43\x9d\xad\x6f\x09\x01\x51\x8b\xde\xa2\x34\x7c\x1c\x07\xe1\xa5\x3a\x84\x80\xec\x24\xb6\x15\xaf\x1d\x6c\xdb\x93\x44\xd8\xea\x8b\x21\x03\xc9\xda\xa6\x74\x74\x2c\x26\x0b\x1d\x25\x32\xac\xc0\x7c\xb1\xb4\xfc\xe6",
    "\x04\xf9\xd9\xab\x54\x7d\xce\x5b\x4d\x1c\x47\x78\xda\xe1\x99\x07\x46\xe9\xe1\xf9\xa0\x24\x75\xb4\x6f\x88\xd8\xd4\xcc\x90\x1d\xb3\x48\x98\x8b\xe3\xa5\xb8\x46\x6a\x89\xf5\xa5\x5e\x75\x41\x69\x12\xd4\xb1\x09\xee\xd8\x62\x98\x57\x7a\x71\x8c\x0e\x3a\x02\x3b\x0b\xf2",
    "\x04\x06\x82\xf7\xa7\x8d\x62\x90\xe6\xc5\x9e\x9d\x1b\xde\x9c\xd6\x65\xfa\x24\x23\x21\x98\x38\x5a\x10\x94\x89\x06\xb4\x73\xc5\x9b\x16\x0f\x95\x30\x8a\xc8\xad\xf0\x92\x27\x67\x22\xd6\x8f\x9d\xb7\x7d\x61\xdf\x72\x58\x77\x97\xee\x8c\x3c\xf0\xdf\x45\xae\x19\xa0\xba",
    "\x04\x32\xb2\xb5\xf5\x43\x65\x84\x7d\xcd\x1a\x9c\x96\xab\xb0\x41\xa3\xd6\x48\x3e\x93\x04\x9f\xc3\x44\x0b\x7b\x46\xef\x8b\xac\x8d\x39\x7d\x04\x2d\xd4\x8b\xb9\x92\x8d\xe3\xf2\xe3\x43\xa6\x70\x79\x2f\xe2\x5f\x65\xe5\xff\xcb\xbf\x01\x21\xc4\xa0\xa0\x61\xe5\x5c\xd3",
    "\x04\x3e\xef\x9f\x2a\xf3\x90\xdf\xb4\x56\x80\x0f\xc7\x67\x3f\x1a\xc6\x1b\xae\xfa\x68\xbf\xf8\x4c\xcd\x36\xfd\xfe\x40\x8f\x90\x20\x5b\x86\x5d\xdd\x2c\x60\x36\xce\xb6\x26\x0b\xd6\xe6\xb2\xf2\xb0\xa0\xad\xe9\xa6\x05\x79\xf2\x59\xbc\xb9\x45\xea\x5e\xce\xd8\xbf\xe8",
    "\x04\xbc\x9b\x0f\xee\x1e\x5e\x08\x8c\x77\x60\x8e\x6c\xe1\x63\x13\xa9\x6a\x5b\x72\x5d\xe2\xc7\x7f\xb3\x50\x4e\x8c\x6e\xcf\x54\xba\x27\x88\x37\xf6\xec\xde\xb5\xa5\x37\xd8\x9d\x0a\x65\x5c\xda\xfa\xce\x33\xef\x77\x86\xb9\x49\x53\x3e\xa8\xce\xc9\x06\x94\xb1\x58\x40",
    "\x04\x6f\x8f\x49\x42\xd0\xff\xea\x70\x78\x85\x09\x17\xb8\x50\xb9\x6f\xac\x0d\x10\x10\xff\x9e\xf1\x41\x9e\x5e\x9a\x8f\xce\x94\x79\x6f\xf1\xc4\x51\xf6\x4e\xc8\xe5\xfb\xb2\x0b\xc1\xcb\x73\xfd\x5f\xdd\xdf\x5c\x64\x78\x83\xf3\x96\x6a\x82\xed\x3e\x81\x6d\x8d\xa8\x62",
    "\x04\x99\x5f\x9c\x5d\x5f\x53\x9e\x53\xcd\x10\x68\x37\xca\x3e\xba\x50\x62\x6d\xf5\xdd\x5e\x54\xce\x31\x46\x47\x7c\x57\xcd\x59\x18\xc0\xb8\x3b\x30\xf3\xe4\x69\xc8\xee\x7c\x74\x1c\xd7\xc6\x83\x3e\x78\xee\xab\x71\x0d\xfb\x96\x36\x0c\xe4\x64\x90\x5f\xbd\xa8\x17\x9e",
    "\x04\x99\x91\xc5\xdb\x64\x9d\x7c\xf3\x7f\x0a\x1c\xae\x2b\x4f\x14\x46\x14\x04\xe0\x28\x6c\x0b\x86\xe3\xdd\x54\x62\xa1\x8a\x3e\xc3\x5f\x54\xe6\x68\x65\xa8\xe8\x8a\xab\x14\xf9\x4c\xbd\x87\x78\xc3\xc7\x94\x40\xc5\x4e\x5e\xeb\x5f\x96\xba\x09\x76\x38\x01\x7b\x71\xdc",
    "\x04\x33\xb6\x69\xb2\x34\x6c\x99\x82\x4e\x81\x35\x2a\x25\x4e\xf4\x68\x83\x49\xf4\x15\x70\xf5\x31\xe0\x31\xa9\xc5\x1e\x90\x1a\xa0\xd7\x4d\xc1\x20\x6e\x0b\xd4\x19\x29\xa7\x5e\x44\xee\x3e\x84\x2c\x9d\x74\x6f\x93\x17\x2f\x5d\x9e\x3d\xd7\xa2\x2e\x79\xd0\xfb\xad\x1c",
    "\x04\xd2\xb9\x9d\xa8\x2c\x7d\xa9\x3d\xb7\x2b\x6e\x6a\xb5\x2d\xad\x09\xbd\x71\xd6\x61\xe6\xff\x63\xf2\x21\x70\xaf\xb4\x59\x9f\xd8\x84\x56\xaa\x8f\x55\x5d\x91\x0c\x5d\x4c\xc5\xa8\xcf\xfb\x38\xf0\xcd\x7e\xc5\x14\xae\xec\xf3\xaf\x99\x0d\xc3\xea\x7b\xa9\xd0\xd1\xff",
    "\x04\x3b\xe5\xab\xaf\x68\x0e\x97\xf4\x16\xa6\x65\x38\xf0\x19\x6f\x9a\xc8\xa2\xef\xc4\xf5\xdd\xc7\x3b\xa4\x3b\x6b\x3c\x26\x12\x16\xb1\x0f\x08\xb4\xc8\xc3\x7a\x63\xde\xa0\xd2\xfa\x05\x24\x04\x08\xf6\xd3\xde\x6d\x9f\x73\x0a\xf2\xc4\xe8\x90\xfe\x12\x56\xd1\x34\xaa",
    "\x04\xf9\xb8\x8d\xcf\xf1\x6d\xe9\xf4\xd0\x37\x2e\x36\xdb\xf2\x20\xce\xc9\x50\x99\x04\x10\x03\xed\x4f\x3a\x89\x4b\xc6\xff\xd0\xe8\x81\xca\x45\xf3\xc5\xdd\x05\x18\xd1\x4d\x98\xe7\xe3\x77\x62\x3f\x5c\x4d\x99\xf3\x02\xce\x48\x2b\x0a\x1c\xa0\xc6\xf0\x46\xf5\xd2\x51",
    "\x04\x56\x4c\x42\x38\xef\xba\xca\x15\x6d\x15\x9e\xc9\x45\xb8\x0b\x79\x79\xdc\xe1\x4c\x4a\x59\xd3\x80\xb1\xfc\x24\x2d\x3a\xa3\xde\x0a\xd4\xdd\xae\x72\x62\xa1\x11\x69\x81\x99\x13\xe4\x34\x6c\xb8\x9b\x1d\xdc\x42\x7d\x21\x92\xab\xd8\xf6\xc5\xa2\xc8\x50\x76\x8b\xa1",
    "\x04\x86\xfb\x44\x81\x2e\x92\x84\xac\x48\x43\x46\x30\x21\x72\x9f\x33\xda\x45\xf0\xb9\x0e\x39\x47\xd6\x42\xf8\x43\x20\xfd\x1b\xe6\x8d\xeb\x24\x98\x9b\x48\xb0\xa8\xd5\xc2\xce\x43\x86\x93\xec\x14\x05\xd2\x35\x81\x98\xfa\x93\x9e\xa1\xec\xd5\x2b\x0d\xf1\xfb\xc4\x98",
    "\x04\xa4\xb9\xb7\xa0\x3a\xbd\x09\x35\x43\xb2\xd8\xdd\xdd\xde\xad\x13\xbe\x13\xe7\x52\x9c\xe0\x20\x2b\x5b\x29\xa8\xac\x52\xd0\xcf\xab\xb9\x7b\xae\x52\x30\x1a\x8a\x0e\x48\x53\xf3\x22\x0e\x69\xdd\x2a\x0a\xbf\xce\x52\x6f\xdc\x08\x7e\x7e\x04\x63\xe6\x49\x5f\x73\x9f",
    "\x04\xfb\x09\xaa\x6b\x91\x7f\x13\x6a\x22\x1d\x29\x9e\x4d\x02\x1a\xdb\xb3\x09\xd4\x75\x3f\x94\xfb\x50\x2f\x4b\x6e\x87\xab\xeb\x47\x52\x21\x18\x0c\x34\x67\x76\x2f\x83\x42\xa1\xed\xb5\x5a\x87\x1c\x01\x62\x62\xc1\xa8\x52\x6a\x02\x5a\x9b\xb3\x03\x5e\xfb\xf1\xc5\x66",
    "\x04\xf7\xb1\xdf\xff\x6f\x5b\x91\x43\x2c\x6f\xdc\x0f\x79\xd1\x30\x17\xb9\x5d\x03\xd1\x2e\x8b\x68\x8a\xc4\x46\xf8\x9f\x9e\x57\x49\xd0\x56\xea\x2e\xa3\x2d\x4f\x43\xcf\x12\xb1\x74\xe2\xf7\xdb\xbd\x35\xc8\x6d\x99\x89\x1f\xd1\x55\x12\xdd\xdc\x78\x13\xce\x71\x0d\x6a",
    "\x04\x47\x6e\xd4\x53\x75\x11\xdd\x1f\x24\x58\x8b\xfd\x74\xe3\xe3\x4d\x0d\x41\x58\xd7\x04\x20\x37\xab\xe6\xad\x86\xe9\x1b\xea\xc3\xb2\x9a\x4d\xb3\x3c\x3e\xef\xfe\xaf\x8e\x41\xc8\x69\x96\xda\x29\x92\xa0\xa1\x68\xbd\x7f\x8f\x62\x98\xa6\xf0\xc5\x92\x04\x66\x35\xdd",
    "\x04\xe6\xa3\xba\x1a\x40\x24\xd7\xf7\xa6\x66\xaf\x76\xc8\x80\xf3\x28\x5b\xad\x6e\x94\x54\x16\xb0\x6b\xa6\x6c\x6a\xd2\xc9\xba\x03\x44\x31\x51\x36\xd4\xd2\xa3\x98\xc9\x14\x2e\xc2\x05\xf8\x44\xb8\x96\xe2\xee\xb2\x06\x0a\x3a\xd1\x10\x88\x79\xf8\x11\x04\x09\x02\xb7",
    "\x04\xf6\xd2\x96\x02\xc8\x5f\xbc\x3a\xf8\x4f\x29\x5f\xac\xe5\xb1\x0e\x99\x65\x20\xd1\x9e\x8e\x3b\x95\xe7\x1a\x56\xc3\x0d\x6c\x86\x8c\x38\xe1\x1d\xf1\x62\x93\xc3\x04\xcc\xb9\xcb\x6e\x0d\x4c\x7d\x9e\x7f\x5b\xad\xd4\x88\xe6\x74\x7e\xaf\x88\xd0\xbe\x22\x13\x19\xfe",
    "\x04\x51\x7a\xd3\x85\x4b\xf3\xb9\xfa\x52\xff\x70\x3b\xd6\xd0\xfe\xfc\x61\x40\x6a\x7c\xd6\x06\xcf\xf2\x70\xfc\x8e\xa1\x23\x33\x66\xe5\x59\x23\x21\xa8\xbb\x4d\xbb\xac\xa4\xdf\x3a\x80\xad\x68\xef\x9d\xe9\x2e\x24\x5a\xae\x89\x86\x16\xd0\xab\xab\xad\x5f\x24\x49\xa6",
    "\x04\xe1\xd9\x4a\x45\x34\x5f\xf3\x35\x12\xc6\x3e\xd5\xa6\xbb\x2f\x3f\xb9\x2c\xc1\xdb\x15\x26\x73\x89\xca\xd9\xe8\xef\x70\xde\x3d\xb5\x22\xfa\xad\x29\xad\x06\xf2\xa7\x3f\x17\x4b\x12\xa2\x3e\x49\xc2\x72\xe6\x73\xf2\x8a\x71\x02\x43\xbf\xa8\xad\xc2\xff\xd1\x2f\x1a",
    "\x04\x55\x70\xfa\x35\x43\x36\x48\xd7\xa6\xe9\x82\x74\x62\x9c\x3d\xc5\x65\xe3\x21\x13\x31\x80\x2b\xaa\x64\x08\x7d\x12\xa6\x3c\x53\x48\x80\x71\xa6\x19\xdd\x03\x13\x99\x3d\x42\x3a\x65\xa2\x17\x5b\xab\xa1\xab\xdc\xd5\xdf\x71\x86\xed\x24\x7a\x9e\xac\xeb\x8b\x74\xfd",
    "\x04\x01\xfe\x45\x61\x42\xc8\xfa\x3b\x15\xf7\xd3\x81\xfc\x62\xb4\x0d\xcc\x54\x6d\x57\x86\xaa\xf5\xfd\x08\xd8\xb2\x96\x3c\x90\x89\x50\x96\xce\x77\x3d\xff\x54\xb4\x1e\xf6\x04\x19\x2b\xa9\xdd\x48\x78\x63\x19\xa4\xc5\x3e\x22\x21\x72\x00\xc2\x0c\xf3\xfc\xd9\x5d\x6b",
    "\x04\xc5\x52\x73\x8d\xb2\x6e\xf0\xe8\x9b\xed\x1b\xe8\xad\xe4\x95\x1e\x77\x34\x57\x9f\x5c\x49\x95\x43\x73\xe7\x8a\xe5\xe6\x13\x23\x58\x35\xe7\x83\x52\x55\xeb\x92\xb6\x4d\xba\x9d\x52\xdb\x76\x88\x95\xd8\x89\x0e\x1f\x60\xf9\x55\x22\x12\x7c\xbf\xdf\x50\x15\x81\xa8",
    "\x04\x03\x66\x88\x5c\x11\x55\x2f\x83\x54\xa6\xd6\xd1\x33\xc1\xd3\xa1\xd4\x48\x6a\xc5\xb8\x5d\x94\x73\x3f\x58\x3d\x49\x4d\x39\xaa\x05\xf5\x4b\xb0\xd4\x77\x46\xbc\xc0\x82\xeb\xdf\x7f\x31\x7f\x33\xdf\x32\xe5\x17\x98\x2a\x3e\x14\x54\xfb\xc4\xb7\x76\xc0\x12\xce\x79",
    "\x04\xfb\x24\x6e\xdb\x98\x67\x18\xac\x4e\x89\x2c\x33\x6f\xd3\x10\x0c\xd2\x25\xf3\x89\x80\x60\x42\xd9\xfd\xbf\xf1\xac\x84\xbe\x11\x0e\xe1\xb9\xcf\xa3\x8c\x4b\xd7\xc7\x33\x4c\x8b\x8d\x21\xb7\xd0\x7e\x00\xa1\xb9\x91\x0b\x6b\x10\x3b\x8b\x83\xcf\x4f\x27\xb3\x52\xb4",
    "\x04\x60\x03\xd3\x69\xe2\x4c\xe0\x73\x56\x35\x5c\x3b\xc0\x32\x68\x56\x41\x2b\x9d\x22\x59\x68\x6e\x0f\x39\x1b\x22\x33\x05\xa7\xa3\x89\x4b\x2c\xfe\x92\x85\x75\x28\x65\x32\x6d\x47\xfc\xe2\x23\xea\x24\xd3\xc6\xa0\x87\xfe\xfd\x2a\x80\xf3\x80\x41\xd6\x40\x6d\xa5\xc2",
    "\x04\x44\x81\xac\x1f\x9f\xd7\x6d\xc8\xd8\x7d\x4d\xf8\x89\x44\xfc\xc9\x74\xc8\xef\x4a\x42\x83\x61\x04\x54\xea\xf6\x73\x93\xc3\x8b\xcc\x21\x45\x91\x32\xd9\x0d\x11\x5d\x20\x8a\xfb\xdf\x4b\xf7\x7d\x3d\xed\xe3\xe9\x04\x80\x43\x39\xa7\xfc\xe5\xe5\x7f\x0a\xb1\xbc\x0b",
    "\x04\xc7\xb2\xd1\x6a\x89\x8b\xa1\x23\x3f\xf1\x9a\x3b\xb1\xce\x8c\x89\x56\xf2\xdb\x8b\x42\xb0\xed\x57\xbc\x1b\x1d\x24\x9d\x1e\x2c\xb5\x3a\x80\x0a\x18\x05\x0e\x44\xbb\x2d\x82\xd4\x80\x66\xfc\x61\x7d\xd8\x1a\x07\x39\xdc\x71\x95\x7a\x3d\xaf\x6f\x22\xe3\x0d\x5b\x39",
    "\x04\x6d\x3e\x71\x6e\xb3\x58\x0f\x53\x35\xd9\xd3\x86\x9e\xa0\x48\xc1\xb4\xc0\x65\x81\x77\x16\xf2\xed\xd2\xdc\xb8\xce\xfb\xe9\xf6\xd5\x3f\xe3\xaf\xd7\x6d\x43\xee\x48\xc4\xb4\x46\x7f\xee\x60\x68\x5a\x0a\xfe\x55\x5c\xe2\xb6\x5a\x2a\x6a\x96\x76\x8f\x05\x60\x1b\xc4",
    "\x04\x44\x73\xa7\xc5\x36\x40\x2a\xa2\x09\xb6\x66\xac\xaa\x95\xf2\x83\x79\x91\x6c\xba\xa6\xa2\xf4\xf0\x3f\x54\x46\x98\xe5\x90\xe9\x17\x67\x8b\x10\x2b\xfb\x08\xa8\xbb\x31\xa8\xd7\xef\x4f\x82\x50\x83\x73\xa4\x29\x03\xd5\xbf\x4b\x26\x7e\x4e\x0d\x28\x5d\xa8\x1d\x75",
    "\x04\x51\xe3\x4f\xa1\x5a\x57\xdf\xa8\xc1\xbe\xd9\x2d\x96\x5a\x8e\x9a\xd5\x85\x31\xf7\x98\x51\xf7\xac\xa7\x92\xf3\xae\x55\xe8\x3d\xae\xd5\xff\x4b\x95\x52\xbd\x9b\x49\xee\xfb\x6f\x1a\xca\x17\x3c\xde\x9b\x94\x69\xe7\xdf\x31\x94\xa0\x89\xb8\xf4\xd8\x33\x30\x53\x98",
    "\x04\x34\xaa\xc7\xb3\x81\xd1\x43\xf4\x58\x8e\x50\x18\xec\x95\x6d\x8d\xfc\xbc\xa4\xb9\xe0\x4d\x17\xe0\xc9\xab\xd9\x6c\x5a\x88\xb5\x62\xcc\x81\x6c\x8c\xa2\x4a\x0c\x50\x55\x0d\xf8\x0e\x99\x28\x01\xe2\xfc\x34\x27\xae\x15\xff\x58\x57\x08\x33\x19\x68\x60\x19\xd4\xb5",
    "\x04\x75\x60\xb4\x43\x0a\x1f\xa5\x6f\xf4\x2e\x47\xfd\x5f\x40\x63\xf3\x9e\x99\x3a\x7a\xf0\xf0\x4d\x13\xa7\x5d\x60\x1c\xa4\x25\x08\xba\x11\xc3\x24\x53\x62\x76\x3f\xb0\xc7\x84\x70\x02\xd3\x64\xa4\xd7\x91\x30\x52\x13\x1c\x11\xc1\xc7\x05\x63\x30\xc1\x2e\x9c\x29\xaa",
    "\x04\x08\xa6\x51\x51\x4b\xf9\xe9\x92\xd2\x97\x62\x9b\xe1\xf4\xc1\xef\x78\x04\x76\x04\x51\xba\xd1\x3d\xaf\x70\x1f\xc3\xc6\x62\xf2\x29\x7f\xdd\x16\x6c\xb8\x44\x0c\x6d\x78\x52\x79\x26\xd7\x16\x64\xb1\xeb\x5a\x88\xac\x5b\x75\xfd\x7a\x9a\xeb\xfa\x30\xa2\xac\x2d\xb1",
    "\x04\xb6\xbe\x97\x1e\xc9\xf5\x1d\xe9\x53\xe9\x68\x9a\x9d\x7d\xf8\x28\xf4\x54\x59\xf7\x8c\xbf\xbc\x6f\x9b\xda\xb8\xa1\xd5\xf7\xbf\x63\x05\x99\x12\x07\xc2\xf3\xfc\x48\x69\x5f\x11\x39\x36\xea\xc5\x59\x91\x30\xb3\xbd\x4b\xf3\xf8\xed\x12\x58\x88\xc1\x06\xbf\x66\x75",
    "\x04\xa7\x43\x6f\xd4\x34\x51\x3e\xc3\x74\x8e\x01\xdb\xa2\xf1\xcc\x64\x06\xa9\x45\xa0\x32\x9c\xfd\x3e\x60\xfa\x04\xfc\x81\x96\xd2\x1c\x83\xa8\xe3\x4d\x68\x8a\xfb\x1a\x29\xf2\x51\xef\x29\xea\x65\x98\x49\xea\xc3\x10\xc8\xbc\x38\xec\x29\xed\xc2\x3b\x40\xcd\x86\x0e",
    "\x04\x1e\x43\x2d\x24\xbe\xd0\x3c\x5c\xfd\xdb\x38\x15\x5e\x2d\xf8\xe4\x24\x82\x29\x44\x23\xc7\x9a\x03\x41\xf0\xb8\x60\x73\xd9\x1c\xea\x71\xff\xc5\x8b\xac\xaf\x08\xc1\x15\x11\x46\x1e\x00\x0e\xcd\x6d\xb3\x31\x70\xee\x99\xe1\xac\xa8\xaf\xf8\x9f\x68\xb7\xc5\xdb\x31",
    "\x04\x56\x04\xb1\x19\xb5\xd7\xce\x91\x09\x3a\x42\x9c\x70\xa2\x46\x84\x2d\x91\x50\x39\x0e\xaf\x5e\x98\x53\x0f\xdd\x68\xff\x02\x63\x05\x11\x59\xd4\xba\xed\x1e\xac\xde\x5c\xce\x30\x64\xa0\x61\x91\x03\x48\xae\x3e\x5d\xc8\x8b\x9d\xae\xf5\x41\x74\x18\xb7\xfd\xb5\x7d",
    "\x04\xaa\x59\xb2\x50\x62\x02\xe2\x11\x2e\x9b\xb7\x94\xcf\xe4\x3a\xac\xe1\xc3\x03\x55\x93\x32\x86\x9e\x04\xa1\x51\xa2\xb2\xdc\x70\xd3\x82\xb9\xb1\x56\xcf\xd5\xa7\x10\xff\x47\x6b\x5e\x47\x44\x43\x9e\x77\x63\xe0\x76\xf7\xdd\x83\x4e\xf2\x19\x00\xd9\x49\x79\x8f\x93",
    "\x04\x33\xf5\xb6\xc2\x7f\x93\x48\x9a\x98\xc3\xa1\x09\xca\xe3\xda\x0e\xa8\x6b\x93\xd7\x5c\xf8\x87\x1f\x3f\x78\xe9\x69\x6b\x40\x45\xa7\x34\x2a\xe3\x8a\xc0\x63\x59\xf7\x10\xaa\x2c\x06\xa8\x88\x21\xac\x79\x67\x2c\x24\x98\xfb\xec\x05\x1e\x4f\x15\x25\xe8\xc9\xfa\xe7",
    "\x04\x7c\xbb\xe3\x61\xc8\x4d\xe6\xb9\xc9\xc8\x09\xb1\x2a\x58\x43\x54\x78\x0b\x12\xaa\x89\x78\x76\x73\xcf\xc2\xca\x22\xd4\x8b\xb0\xeb\x43\xa8\xaa\xc7\x81\xd3\x33\xb8\xb9\x19\x56\xbe\x82\x84\x09\x85\xcc\x90\xfd\x9b\xa8\x44\x35\x89\x66\x1b\x6a\xa3\x08\x47\x8e\xc6",
    "\x04\x76\x8c\xdf\x59\x73\xc3\x4f\x02\x7a\xbb\x68\xe8\x68\x44\xeb\x98\x1b\x3d\xdb\x5a\x5f\x11\xf8\xc0\x79\xb0\x4f\xe6\x58\xaf\xec\xcc\x81\x63\xca\xb7\xe9\x71\x20\xad\xa6\x31\x3a\x2c\x30\x07\xa9\x48\xa1\xea\x1b\x3d\x46\x61\x06\xcf\x47\x2a\x12\x79\x74\xa9\x71\xce",
    "\x04\x1b\xc1\xb5\x19\xa2\xa6\x7f\x14\xc9\x1b\xc8\x05\x2c\xc3\xd9\x4a\x7a\x28\x24\xd7\x42\xab\xb1\xbe\x65\xc7\xd8\x60\x85\xed\x0b\x15\xc6\x78\xff\x50\x8b\x01\xad\xd8\xbc\x5f\x24\x29\x5f\x4b\xfb\xfb\x01\x26\xc3\xbb\xb0\x5b\xa0\xbb\x59\x60\x62\xba\x37\xf8\x6c\x43",
    "\x04\xec\x87\xda\x7c\x53\x83\x69\x61\x4e\xad\x4d\x3a\x3b\x35\x9f\xa2\x24\x68\xfa\xc8\x4a\x10\x16\x23\xf2\x39\x4e\xea\x10\xc8\xab\x92\xb2\xf1\x18\x95\x13\x33\xa3\x53\x11\xe1\x1c\xff\xa2\xec\xb9\xf7\xa9\xb9\xd5\xe1\x36\x0e\xfc\x63\x6f\xc8\xb1\xbe\x83\x0c\x81\x2b",
    "\x04\x87\xcb\x00\x69\xf2\xa4\x3c\xd3\xc0\xbe\x0d\x5e\x61\x64\xbb\x2a\x4d\x56\xdb\x2b\xd9\x62\xb2\x5b\x71\x59\xbf\xf0\x4d\xf2\x86\x01\x0b\x4e\x2c\x54\x98\x2e\xe7\x2f\x57\x30\x93\xde\xde\x1e\xf7\xe7\xb3\x37\xbd\x0a\x01\x81\xf2\x70\x09\x8c\xc3\xae\xeb\x74\x3b\x5a",
    "\x04\x87\xe1\x82\x23\x78\x26\x42\xf5\x60\x5f\xbc\x2c\xab\x0c\xb3\xd7\x8a\x35\x36\x7d\xa7\x5b\xc3\x46\x6a\xef\x5f\xce\x03\x37\x5f\xb3\x6b\xb2\x4f\xe3\x65\x3d\xa9\x08\x5f\xde\x2d\xb7\x56\x24\xa2\x28\x38\x66\xf0\xd3\x9b\x78\x8a\xd9\x53\x8a\x77\x95\x77\x9c\xff\xdb",
    "\x04\xd3\xb4\x53\x08\x44\x56\x09\x6b\xc3\x0d\xd5\xac\x28\xd6\xcb\xab\x06\xca\x40\x42\x45\x43\xfc\xc7\x2f\x3b\xec\xc1\x98\xe4\xcb\x14\x72\x8b\xbd\x52\xcc\x45\x2e\xb7\x41\x77\x29\xc0\xe5\x28\x32\x77\xc3\xa1\x7a\x5d\x2f\xaa\x4e\x26\xd4\x08\x80\x56\x07\x34\xd1\x9b",
    "\x04\x8b\xf5\xab\xf8\x2e\x6f\xd1\x0f\x35\x16\xf0\x58\x6c\x0c\xf0\x91\x94\x1f\xd1\x74\x11\xfd\xa4\x33\x3b\xbe\x86\x75\xc9\x7f\x63\x95\xb5\xcf\x4e\x0b\x6c\x32\xc2\x10\x05\xa7\x5e\x3c\x4c\x95\x0a\xbd\x0c\x34\xfb\x8c\x87\x22\xd4\x7c\xf1\x7b\x3f\xb7\x1f\xaf\xb3\xdd",
    "\x04\xe1\x23\xe5\x63\x9a\xe7\x97\xed\xb3\x89\x87\x55\x34\xb2\x23\x43\x9c\x8b\x94\x00\xb3\x2d\x79\x9d\xf3\xf2\xe3\x31\x9c\x87\xa2\xbd\x52\x7f\x0f\xbe\x7b\xed\x07\x18\x6f\x78\xb5\x91\x50\x3a\xbf\x45\x3a\xf5\xa0\x01\x69\x84\x17\x67\x64\x39\x6f\xf4\x74\x66\x61\x6d",
    "\x04\x97\x67\xf3\xb3\x1f\xd6\x67\x97\x58\x31\xff\x39\x96\x4e\x38\xed\xa5\x3a\x1a\x9b\xad\x3a\xe0\x80\x7d\x29\xd3\x92\x9a\xb3\x79\xcf\xd2\x7d\x4c\xb9\x35\xf9\xc0\x89\x82\x9d\x6a\x51\xc7\x83\xca\x8e\x73\xb0\x6c\xec\x19\x54\x37\xff\x58\xd8\x0e\xd1\x18\x79\x29\x1b",
    "\x04\xe9\x5d\xfd\x53\x6e\x3e\xd2\x4c\x55\xa7\x6b\x55\xcb\xaf\x74\xfe\x1a\xce\xb8\xb6\x32\xfa\xcf\xad\x12\x05\xd6\x08\xcb\xd0\x28\x2d\x77\xd4\x58\x68\xff\x49\xd3\x1a\xfc\x01\x7d\xdb\x17\xdd\xb1\x68\x53\x59\x29\xfa\xa0\xd2\x32\x03\xda\x71\x54\x6b\x9c\xbf\xfe\xf6",
    "\x04\x85\x34\x55\xc8\xcf\x75\xda\x9e\x19\xc8\xee\x89\xe7\x30\x57\xef\xc9\xd4\xcd\x80\x08\xda\x4c\x08\xe2\xa5\x90\x3d\xeb\x71\x2b\xef\x3c\x9d\x2b\xb0\xa8\x53\xa3\xa2\xe2\xd7\xb1\x0a\x87\x30\x25\x4b\xab\xd8\x96\x39\xc2\x37\xdc\x54\xed\x64\x9e\x48\x88\xfb\x5a\x8e",
    "\x04\xee\x55\x29\x98\x00\xe7\x73\x9b\x56\x73\x02\x9a\x1f\xb8\xd8\x89\x76\xe8\x14\x42\xc7\x1e\x2b\x00\xec\x19\x66\x5c\x65\x78\xd3\x3d\x96\x0e\xdd\x54\x6c\x26\x36\x14\xf4\xa4\xf1\xdd\xfe\xe6\xc9\x16\x02\x2b\x85\xf5\xfe\x5a\x3f\x67\x5d\x49\xb6\x5d\x28\x99\xed\x21",
    "\x04\x81\x3b\x0d\x01\x1e\x25\xcc\xea\x0a\x6c\x27\x7d\x80\x32\xea\xf7\xc4\xf0\x55\xd8\x9e\x8c\x4b\x53\xc1\xad\xa8\x35\x54\xf4\x1f\x0c\x86\x46\x81\xc6\xb3\x61\x12\xa9\xf4\x7c\x65\x12\xe5\x03\x3f\xbf\xac\x9c\x5c\xaa\xad\x2b\xbc\xa1\x5b\xaa\xcb\xb0\x92\xc0\x7b\x6b",
    "\x04\xa8\x00\xbe\xfd\x17\x6b\xc4\x9d\x7b\xba\x6d\x2e\xc9\x80\x7e\xe7\x2d\xea\x03\x93\x77\xf7\xb0\x27\xa4\xaa\xb0\x9e\xcc\x12\xa0\xfa\xfe\x80\x39\x4d\x34\x6a\x8b\xf1\xa3\xa4\xa2\xc7\x74\x2f\x9f\xdb\x88\x14\xa3\xd0\x1d\x36\xd9\xe1\xdc\x90\x34\x0f\xb6\xaa\x7a\x4e",
    "\x04\xfb\x15\xf2\x04\xf7\xc4\x7f\xa2\x1b\xde\x4f\xf3\x65\x93\x80\x71\xea\x40\x28\x16\x04\x88\x19\xbd\xde\xdf\xca\x82\x64\xd0\x20\xf0\x64\x6a\xc5\xc0\xcf\x47\xdf\x85\x79\x4b\x4d\xd0\xa1\x7b\x78\x8b\xdd\x09\xd4\x55\x82\xe8\xe6\xb9\x56\x2a\x53\x87\x69\xf2\x47\x5d",
    "\x04\xbb\x7f\x11\xa5\x1e\x91\x02\x56\x81\xd9\xd3\x29\xdb\xb1\xfd\x4e\xe4\xea\x1e\xba\x6a\xfb\x9c\x89\x02\x2d\xd5\x55\xce\x44\x23\x31\xbe\xd3\x21\x50\x01\xaf\xe6\xd7\xbc\xdf\xf5\xa8\x21\x5a\x4e\x03\xf3\xb7\x90\xa7\xe4\x71\x82\x18\x4a\x64\xad\x13\xd0\xd4\x25\xbf",
    "\x04\x66\xa3\xf9\xe7\xa7\xeb\x51\xac\x22\xe4\x6c\x97\x2b\xce\xfc\x4a\xe1\xb3\xcf\xcb\xc4\xa5\x32\xb4\xd7\xe5\x1e\xc4\xbb\xb0\x02\xce\x8e\xd3\xaf\x4a\x94\xfd\x6f\xb4\xfc\xfa\xfa\x22\x52\xca\xf3\x28\xd6\xa7\xdd\xf1\x6e\xdf\x76\x07\x96\x19\xcb\xe4\xa2\x4d\x89\xd5",
    "\x04\xb9\xf0\x7b\xb4\xed\xe8\xae\xd0\x08\xd6\x5b\xa6\xba\xa5\xc8\x74\x32\x39\xcc\x68\xbb\x7b\x34\x71\xe2\x90\xea\xaf\xf7\x16\x01\x45\x39\x32\xf4\xf0\x32\x1c\xb7\x61\xcd\x8f\x26\x94\xab\x16\xe4\x05\x29\x7c\x4a\xd9\xed\xe7\x51\x31\x0a\x09\x97\x8d\xe7\xb0\x08\xbe",
    "\x04\x94\x9f\x48\x7a\x41\xfa\x7d\x9b\x03\x68\xa8\x9e\xb9\xe1\x6c\x88\x5b\x93\x7b\x08\x41\x2f\xe6\x56\x55\x88\x83\x78\x62\x53\x7a\xf3\x7a\x2b\xc7\xc7\x00\x9a\xf2\xe9\x21\x27\x3a\x31\x33\xe8\x58\x14\x75\x09\xb4\x15\xb2\xf4\x9e\x9f\x8d\xa1\xf6\x9a\x49\x17\x58\x14",
    "\x04\x35\x48\xe3\x30\xca\xaf\x10\xc4\x69\x6f\x2a\x71\x2f\xb5\xb2\xb6\x9c\xd6\x31\x6d\xe6\x4d\x44\x05\xc5\xf2\xf3\xd7\x4b\xfa\x44\xb5\x2a\x72\xa6\x8a\x58\x85\x66\x77\xd2\xb0\xfb\x20\x54\x17\x66\x23\x64\x32\xf0\x80\x7d\x6c\x2e\x7e\x89\x7a\x2d\x50\x8f\xab\x8b\x80",
    "\x04\x3a\xa5\x76\xa8\x17\x1b\x73\xb0\xf6\x53\x53\x2c\x0b\x0f\x6f\x49\xb8\x93\x04\x5b\x80\xf9\x9e\x22\x14\xf2\x07\x09\x3b\x26\x3f\x17\x3d\x46\x7c\x9c\x54\x2e\x4a\x9c\xc2\xb0\xdd\x1f\x6d\xc4\x62\x38\x08\x4c\x32\x96\x12\xb6\xa5\x4c\x32\x5f\xa0\x0b\xba\xad\xfc\x59",
    "\x04\xc9\x82\x54\x73\x97\xaa\xb0\xb9\x91\xbb\x02\x00\x33\x6c\x81\x0a\x7b\x72\x47\xfc\xa7\x66\x15\x01\x2b\x1b\xe8\x30\x7d\x17\x63\x61\x74\x09\xfc\xed\xb5\x31\xd4\x4e\xc8\x3d\xfc\x25\x31\x0f\x38\xa4\x6d\xdb\x83\x11\x27\x68\xdc\xb8\xe3\x1c\xe3\x4e\xfd\xe3\x1d\x17",
    "\x04\xe4\x5e\x1b\x9d\xfc\x8c\xa9\xa0\x3c\x01\x26\xb6\xe0\x7f\xad\xb3\x8b\x20\x29\xb0\x3f\x97\xee\x2e\x3c\x9e\x7f\x24\x75\xaa\x96\x1c\xbf\x6e\x8c\x9a\xfb\xe6\x08\x6b\x32\x1b\xc2\x25\xa3\xe4\x4b\x31\x57\x18\x5c\x6e\xbe\x21\x13\x0c\xad\x1b\x34\x67\x12\xea\x17\x16",
    "\x04\xcd\x33\xb4\x7e\xff\x77\x44\x2e\xb5\xab\x5f\x67\x86\x9e\xfc\x47\x0c\x62\x09\x79\x70\xb6\x6d\x0d\x74\xfe\x7c\xa7\xfd\x70\xeb\x76\xb0\xad\xc7\xdb\xe6\x78\x8a\xc5\xf4\x2f\xe7\x53\x75\x0c\x97\x43\xe7\xf4\xd0\xd4\x88\x96\x3a\x01\x84\x0c\x3a\x66\xaa\x03\x83\x17",
    "\x04\x33\x70\xff\x05\x0a\x99\xe4\x31\x72\x6f\xfe\xe0\x5c\xbc\x95\x22\x5d\x09\x6e\xcc\xa1\xe5\x34\x51\x6e\x7c\x40\xe7\x41\x94\x3f\x64\x10\xef\xf4\x4a\xf4\x18\x74\x3a\x11\x7d\x9b\x17\x44\x51\x68\x5a\x4e\xaa\xd2\xa6\x03\x64\x5d\x49\x18\x13\x69\xd5\x4f\x81\x71\x4a",
    "\x04\xcf\x6b\xd3\xc4\xbb\xea\xdf\xa9\x39\x95\x7a\xa3\xe0\xed\x7a\xce\x55\xa0\x30\xa8\x56\x98\xa8\x87\x69\x76\xa6\x9f\x65\xe5\x84\x3d\x93\x32\x20\x0a\x24\x29\x57\x47\x3d\x38\x71\xa7\x9e\x90\xd3\xe3\xe9\x02\xcb\x74\x9f\x99\x9e\x9b\xa3\x53\x37\x04\xbb\xf9\x8c\x8d",
    "\x04\x8b\x8e\xa1\x86\xa6\x96\x3a\xa7\x46\x0c\xb1\x44\x62\x2d\xaf\x28\xde\xec\xf1\x32\xe3\x8d\x5e\xc2\x6d\x82\x46\x4c\x27\xeb\xf9\x3e\x16\x91\x5e\xb9\x53\xbd\xd1\xd2\x94\x87\xbe\x55\xbe\x1a\x56\x6e\x1a\x90\x49\x55\xf5\xfc\x70\x0e\x03\xe6\xbb\x2c\x55\xe9\xd3\x0d",
    "\x04\xfb\x36\xdf\xe7\x94\x9c\xbc\xad\x86\x3b\x2f\x3c\x7c\x71\xb1\xbd\xa0\x1c\x95\x4e\x82\x11\x10\x3e\xca\x93\x15\x3d\x44\xbe\x5a\x4b\xc3\x29\xdf\x25\x43\xda\x17\x67\x26\x3a\x2e\x8b\x65\x96\xa4\x27\xa5\x5b\xa7\x35\xaf\xf3\x32\x49\xdc\xfe\xc8\x9d\x8f\xc8\xfb\x49",
    "\x04\xe8\xb5\xc2\x6c\xae\x0c\x77\x19\xdf\x23\xb8\x8a\x80\xab\x67\xcd\x41\x8f\x92\x9a\x93\x2b\x4e\xe4\x9a\x52\x04\x9c\xce\x09\x68\x83\x8c\x80\x59\x42\x00\x50\x06\xbb\x49\x43\x16\x76\xa0\x8b\x65\x34\x40\xc8\x57\xa6\x13\x5b\x09\x8c\x7f\x30\xd6\x21\x62\x24\x0d\x9d",
    "\x04\x08\x67\xf9\xcd\x46\xec\x9d\x0f\xf0\x98\x30\x3d\xca\x4d\x32\x97\xfe\xee\x1d\x00\xb2\x0d\xa7\x3d\x9c\xf2\xe6\xba\x0a\x9e\x83\xf5\x96\xa6\xed\x88\x24\x01\xcb\xfe\xdb\x34\x5c\x10\x5a\x7c\x5f\x80\x4d\x68\x3a\x77\x14\xd0\xba\xe4\xaa\x7e\x02\x73\x77\xfb\x0c\xa8",
    "\x04\xce\xed\xd2\xc6\x3a\x20\xca\x20\xd9\xf8\x4f\x83\xf1\xd2\x76\x17\x72\x2e\xcb\xa0\x21\xef\x21\x7f\xad\x0d\x1a\xd2\xf5\x8b\x76\x00\x6a\x32\xe8\xc7\xea\x53\xf7\x65\x7a\x5e\x1f\x6f\x4e\xa1\xa4\xa5\x50\x81\xa3\x67\x0b\xc7\xed\x8f\xa2\xbd\xe2\xcf\xf4\x65\xf1\x2a",
    "\x04\x99\x47\xa8\xd9\x57\x3b\xeb\x26\xf6\x1f\x49\x9d\xa8\x43\x5f\xba\xa6\x9e\x02\x01\x45\xa5\xf1\xfc\x2e\xfa\x15\x58\xdb\x47\x47\x05\x6c\xd3\x6e\x29\x9f\x92\xfb\xb9\xc9\x8f\x3c\x7c\xbf\x04\x98\x5f\xb7\xc0\x9f\xac\x83\xbe\x3b\xac\x2e\x4b\x30\x78\x12\x9e\x53\x83",
    "\x04\x08\x24\x83\xf5\xc4\xd0\x3f\x74\x36\x5f\xd6\x68\x24\xbd\x02\xf7\xbe\x14\x61\xc3\x55\x92\x65\xde\x71\xf7\x70\x2f\x16\xfa\xcc\xee\x4d\xe0\xbc\x2e\x5e\xa8\xdc\x05\x46\x15\x35\xb8\xec\x47\x6b\x31\xb1\xa4\x47\x74\x4b\x4e\x6d\x86\xb9\x8f\x7a\x5e\xce\xd6\x29\xb9",
    "\x04\x2b\x89\x2b\x39\x4e\x21\xf3\x1d\xe4\x3e\x6a\xaa\x89\x9d\x15\x84\x58\xda\x57\x78\x28\x7e\x50\x81\x53\x58\xeb\x25\xde\xe9\xcd\x59\x8e\x8d\x20\x71\x51\x94\x37\xa9\xd0\xc2\x53\xa2\xb6\xfc\xfb\xd6\xd9\xdf\x32\xed\x7c\x1d\xf9\xdf\x43\x1c\x55\x2e\x86\xca\xf1\x25",
    "\x04\xef\x30\xa5\x87\x7f\xc4\x17\xb7\xaa\x8e\xa2\x1f\x1b\xf7\x61\x60\x02\x8a\x49\xa0\xcd\x43\xe5\x24\xa3\xd9\xbc\x44\x49\x62\x33\xb1\xc5\x77\x3c\x0b\x58\xfe\xc3\x0d\x96\x52\xca\x3c\xa5\x38\xb2\x03\x10\x74\x99\x49\xd3\x8e\x2d\x16\x44\xcd\x7e\x38\x09\xb3\x3c\xc1",
    "\x04\x67\x6f\x97\x23\x81\x9f\x36\x51\x8a\xd3\x4e\x7b\x21\xd6\x9f\x83\x0b\x43\xfb\x96\x6c\x0a\x3e\x8d\x11\x16\xbd\x3f\xa0\x61\xfe\xa5\x09\x98\x82\xaf\xbe\xd5\xbf\x34\x3a\xe4\xb9\x5b\x4b\x0a\x13\x62\x2c\x22\x9e\xa0\xa5\x55\xd2\xc4\x78\x68\x60\x96\xf5\x68\xa6\x47",
    "\x04\xab\xb4\x36\x3b\xdf\xc5\xa9\x11\x78\xdd\xc8\xa4\xcd\xc0\x5d\x2e\x06\x16\x78\x35\x94\xc5\x3d\x5a\xf2\xc2\xd3\x4c\xaa\x9b\x78\x7e\x68\x54\x34\x09\x7f\xe4\xff\xf5\xaf\x14\x9a\xcf\xaa\x9a\xb5\x7a\x80\x60\xef\x9d\x26\x0c\x0b\xfb\xa0\xea\xbd\xf9\xfa\xd4\x0c\x4b",
    "\x04\x32\x20\xfd\xdf\xbf\x5a\xe6\xbc\x63\xff\x75\x0f\x5f\x04\x0a\x2a\x6e\x5c\xd8\x81\x7a\x74\x50\xae\x48\x65\x3b\x6a\x14\x89\xfb\xaf\x86\xc9\xf4\x2d\x6e\x31\xc4\xbe\x25\xe2\xed\x9f\xc1\xca\x68\x11\x4d\x01\xf0\x01\xa3\x6b\xde\x77\x64\x98\xe7\x03\x77\xd7\x32\x7f",
    "\x04\x17\xa2\x0d\xa4\xae\x93\xc3\x53\x2a\xfd\xef\x5f\x5a\x29\x12\x40\x80\xeb\x98\x09\x12\x14\xc9\x52\x0d\xc6\x0d\xd2\xc5\x9d\x14\xa4\x55\x61\xbc\x39\x24\x7c\xba\x51\xed\xad\x19\x0f\x34\x55\x13\x09\x94\x81\x00\xd5\x03\x2a\xfa\xb9\x86\x2b\x7e\xa0\xc6\x09\x59\xc8",
    "\x04\xf3\x78\x38\x0a\x8a\xee\x14\x72\x44\x9e\x94\x45\x2e\xf3\x66\x30\x5a\xbe\xe4\xf7\x97\x29\x8e\x80\x39\x8c\x0b\xec\xc3\x39\xee\x9a\x1a\x3a\x4d\xf3\x4a\xf6\xf1\x07\x03\xd3\x81\x6b\x37\x7f\x0e\x35\x77\xec\x97\x7d\xc2\x15\x8a\xb2\x5e\x6a\xec\x18\xd1\xb9\x2e\x45",
    "\x04\x9a\x27\x63\xf2\x39\x33\xd8\xcb\x56\x64\xf4\x6a\x4b\x1c\x62\xcb\x55\x08\x7d\x21\xa6\x55\xa8\xcb\x27\x11\x04\xa3\xb9\x73\xc5\xe4\xb4\xc4\x95\xa3\xbd\x83\x4b\x67\x2e\x98\x20\x61\x41\xbe\x46\xf3\xe8\x23\xba\x4e\x20\xb1\x8b\x33\xde\x83\x52\xc5\x44\xa9\xb5\xb9",
    "\x04\x5f\x6f\x1d\x56\xa4\x29\x49\x73\x60\xa8\x79\x58\xef\xb9\x2a\x0a\x17\xc1\x92\x1c\xe5\xb8\x5d\xb1\x63\xaa\xe2\x2f\xc4\x28\x12\x9d\xa8\xbc\xac\xe8\x81\x2a\x0e\x0b\x3f\x80\x93\x5f\x4e\xa0\xc7\x1f\x53\xc0\x89\xdf\x02\x49\x06\xf0\x96\x30\xcc\x4d\xcb\xae\x69\xd2",
    "\x04\xb3\x97\xd8\x87\x3b\x66\xeb\x27\x78\x28\x1c\x0b\x17\x82\xe9\xc1\x73\xde\x60\x21\xfe\x7d\x44\x6d\xe6\xd0\xaa\xdd\xc3\x94\x6f\xcd\x6f\x71\x1c\x5e\x84\xd3\x54\x8c\x28\xcd\x11\xba\xb5\x48\x50\x4a\xc1\xdd\x25\xc7\x96\x0a\x0c\xfb\x1a\x09\xc4\x5e\xcf\x88\x59\x3b",
    "\x04\xc9\x11\x60\xf9\x25\xc7\x10\xc3\xba\x4b\xef\xe7\xe6\xab\x22\x69\x2a\x63\x3d\x58\x65\xe0\x2d\xd4\x9a\xd5\x43\xec\xc0\x3d\x78\xa1\x80\xb3\x2b\xd1\xc1\x0a\x1e\x37\xc0\xc2\xd8\x43\x9e\xee\x0a\x90\x65\x11\x3a\x3d\xc9\x63\x98\x07\x30\x6d\x36\x0d\x3c\x86\xc6\x39",
    "\x04\xa9\x45\x17\xc0\x95\x52\x8c\xf6\xa7\xb6\x5a\xdb\xd1\xf6\x72\x3b\x28\x40\x39\x2a\x58\x76\x30\xb8\xf1\x08\x9b\x4a\x74\x4f\xbf\x02\x6f\x3f\x59\x4c\x1b\x0e\xa7\xd1\xf4\xd7\x0c\x76\x48\xeb\xde\x51\x5a\xef\x4e\xea\xca\xcb\xcb\x46\x28\x7e\x08\x6b\xaa\xab\xec\x42",
    "\x04\x9d\xf6\x89\x15\x8d\x44\xe0\x61\xb5\x36\x2f\xe4\x05\x49\xfa\x6b\x22\x31\xe6\x4d\x01\xc3\xfe\x43\xcc\xb8\x56\x6b\xbf\x40\x17\x8f\x50\x1a\x9a\xa6\xa3\xc4\x5d\xfb\xcb\x6a\x92\x12\xa1\x9e\x68\xc1\x2b\xf1\x87\x88\xca\xb7\x1b\x72\x5d\x44\x12\x9c\x5a\xe6\x5d\x62",
    "\x04\x0f\xea\xd3\xb0\x41\x18\x4e\x24\xb1\xbb\x46\x1c\x6a\xcc\xf1\xb3\x5c\xf6\x3c\x55\xbc\x68\xe2\xee\xa7\x70\x60\x33\x1b\xb1\x4c\x68\x0c\x80\x65\xcd\x8a\x4e\xe1\xd8\xaf\x2f\x8f\x8b\x29\x5c\x98\x25\x70\xc9\xaa\x49\x95\xf0\x0b\xf2\x6a\xac\x3b\x04\x97\x5a\xab\x83",
    "\x04\xfc\xe4\x3a\x14\x5b\xfd\xb4\x69\xd1\xe4\x51\x34\xff\x68\x25\x4f\xe2\x60\xef\xc9\xb5\x8c\x3c\x6b\x36\x7a\x9e\xc5\x87\xb3\x79\xc0\x54\x71\x97\xb4\xf8\x86\x5b\xab\x06\xcf\xa4\xf8\x6f\xd9\x4e\xbe\x31\xe9\x21\xc7\x64\x02\x42\x8c\x94\xe1\x5d\x44\x8f\x8d\x0e\x0e",
    "\x04\xd6\x58\x31\x02\x9a\xe2\x1c\x55\x4c\x2b\xa4\x42\xa5\x5b\x92\x80\x2a\x82\x84\x06\x80\xb8\xb9\x5c\xf4\xb9\x39\xf7\x97\x2f\x01\x38\x83\xba\x99\x81\x39\xaa\xe8\x96\xaf\xf4\x1b\xb2\xeb\x73\xe1\xa2\xfb\x1b\xfa\xaf\x19\x58\x82\x3b\x87\xa2\xb1\x83\x08\x96\x98\x1b",
    "\x04\x8b\x86\xb0\x98\x4f\xcc\x63\x43\x4b\x12\xdc\x57\xf2\xc3\x89\x6e\x78\x51\xcd\xb7\xed\x90\x7b\x18\x78\x0f\xf7\x5b\x47\xef\xf7\x38\x35\x5f\xc2\xb0\x28\xdc\x2e\x16\xae\xdc\x63\xf3\xdd\x8d\x86\x4f\xc4\x50\xe1\x41\xcc\x0f\x21\xb4\x16\x67\x6c\x69\x3c\xf5\x7f\xfd",
    "\x04\x78\x70\xa2\x56\xd9\xac\x4e\x25\x3c\x24\x7d\xc7\x1a\xd4\x04\xc3\x60\xf1\x91\xcb\x40\xec\xbb\x81\x00\x4b\x6c\x8a\x80\xfb\xf6\x10\x20\x1b\xb5\x7d\xed\x75\x87\x46\x20\xa8\xaa\x1e\xa8\xcd\xcd\x60\x04\xe8\x42\x42\x81\x0f\xe4\xc0\x3c\x0a\xc8\x3d\xd4\x2e\x57\x0a",
    "\x04\xc6\x15\x92\x83\x41\x2e\xf6\xcf\xa7\x46\x60\x56\x5a\xa5\x1d\x3f\xee\x4e\x7f\x85\x2d\xa6\x2f\x9b\x33\x63\x3f\x62\x6c\xda\x4d\xfa\x8c\x39\x37\x49\x40\x64\x0b\x94\xfc\x07\x5d\x15\x75\x54\x5c\xc7\x68\x5c\x96\x91\x37\xb2\x7e\x9d\x0d\x17\x8f\xeb\x2c\xa0\x06\x23",
};
/* clang-format on */

uint32_t __stack_chk_guard = 0;

typedef enum {
    OP_SET_ATTESTATION_SALT = 'a',
    OP_GENKEY = 'g',
    OP_SET_CERTIFICATE = 'c',
    OP_SC_ROLLKEYS = 'k',
    OP_REBOOT = 'r',
    OP_BLE_RESULT = 'b',
} op_code_t;

typedef enum {
    ERR_OK,
    ERR_INVALID_INPUT,
    ERR_FAILED,
    ERR_UNKNOWN_COMMAND,
} error_code_t;

typedef enum {
    BLE_OK = 0,
    BLE_ERR_FW_TOO_LARGE = 1,
    BLE_ERR_FLASH_FW = 2,
    BLE_ERR_GET_METADATA = 3,
    BLE_ERR_SET_METADATA = 4,
    BLE_ERR_READ_FW = 5,
    BLE_ERR_FW_SIZE_MISMATCH = 6,
    BLE_ERR_FW_CHECKSUM_MISMATCH = 7,
    BLE_ERR_FW_MISMATCH = 8,
    BLE_ERR_SPI_ERASE = 9,
    BLE_ERR_FW_NOT_ALLOWED = 10,
    BLE_ERR_NOT_BOOTED = 11,
} ble_error_code_t;

static ble_error_code_t _ble_result;

static void _rtt_send(const uint8_t* msg, size_t len)
{
    if (len + 2 >= BUFFER_SIZE_UP) {
        Abort("Buffer to send to host too large");
    }
    uint8_t len16[2];
    len16[0] = (len >> 8) & 0xff;
    len16[1] = len & 0xff;
    rust_rtt_ch1_write(&len16[0], LENSIZE);
    rust_rtt_ch1_write(msg, len);
}

static bool _rtt_receive(uint8_t* msg_out, size_t* len_out)
{
    uint8_t buffer[BUFFER_SIZE_DOWN]; // Adjust size as needed
    while (1) {
        int read = rust_rtt_ch0_read(buffer, sizeof(buffer));
        if (read == 0) {
            continue;
        }
        if (read < LENSIZE) {
            screen_sprintf_debug(2000, "Error: read less than 2 bytes: %d bytes.", read);
            // TODO: send error.
            return false;
        }
        // util_log("read %s", util_dbg_hex(buffer, read));
        uint16_t len = *((uint16_t*)buffer);
        if (len >= BUFFER_SIZE_DOWN - LENSIZE) {
            screen_sprintf_debug(
                2000, "Error: read more than buffer size: %d bytes (total read: %d)", len, read);
            screen_print_debug_hex(buffer, read, 5000);
            return false;
        }
        *len_out = (size_t)len;
        memcpy(msg_out, buffer + LENSIZE, (size_t)len);
        return true;
    }
}

/**
 * Computes the hash which is signed by the root key.
 * @param[in] attestation_device_pubkey 64 bytes P-256 pubkey.
 * @param[out] sighash_out must be 32 bytes
 */
static void _attestation_sighash(const uint8_t* attestation_device_pubkey, uint8_t* sighash_out)
{
    uint8_t msg[32 + 64];
    memory_get_attestation_bootloader_hash(msg);
    memcpy(msg + 32, attestation_device_pubkey, 64);
    if (wally_sha256(msg, sizeof(msg), sighash_out, SHA256_LEN) != WALLY_OK) {
        Abort("wally_sha256 failed here");
    }
}

static void _api_msg(const uint8_t* input, size_t in_len, uint8_t* output, size_t* output_len)
{
    output[0] = input[0]; // OP_CODE
    error_code_t result = ERR_OK;
    size_t out_len = 2;
    switch (input[0]) {
    case OP_SET_ATTESTATION_SALT: {
        if (in_len != 1 + 32) {
            result = ERR_INVALID_INPUT;
            break;
        }

        const uint8_t* salt = input + 1;
        // This is the salt that will be used for the attestation, persist for later use.
        if (!memory_set_attestation_bootloader_hash(salt)) {
            screen_print_debug("setting attestation bootloader hash failed", 0);
            result = ERR_FAILED;
            break;
        }
        break;
    }
    case OP_GENKEY: {
        screen_print_debug("generating pubkey...", 0);
        uint8_t pubkey[64];
        if (!securechip_gen_attestation_key(pubkey)) {
            screen_print_debug("generating pubkey\nfailed", 0);
            result = ERR_FAILED;
            break;
        }
        if (!memory_set_attestation_device_pubkey(pubkey)) {
            screen_print_debug("setting pubkey\nfailed", 0);
            result = ERR_FAILED;
            break;
        }
        memcpy(output + 2, pubkey, 64);
        out_len = 2 + 64;
        break;
    }
    case OP_SET_CERTIFICATE:
        if (in_len != 1 + 64 + 64 + 32) {
            result = ERR_INVALID_INPUT;
            break;
        }
        const uint8_t* attestation_device_pubkey = input + 1;
        const size_t pubkey_size = 64;
        const uint8_t* certificate = input + 1 + pubkey_size;
        const size_t certificate_size = 64;
        const uint8_t* root_pubkey_identifier = input + 1 + pubkey_size + certificate_size;

        // Verify sig
        secp256k1_context* ctx = wally_get_secp_context();
        secp256k1_ecdsa_signature sig = {0};
        if (!secp256k1_ecdsa_signature_parse_compact(ctx, &sig, certificate)) {
            result = ERR_INVALID_INPUT;
            break;
        }
        uint8_t msg32[SHA256_LEN] = {0};
        _attestation_sighash(attestation_device_pubkey, msg32);
        bool matches_a_root_pubkey = false;
        for (size_t pubkey_idx = 0; pubkey_idx < sizeof(_root_pubkey_bytes) / ROOT_PUBKEY_SIZE;
             pubkey_idx++) {
            secp256k1_pubkey pubkey;
            if (!secp256k1_ec_pubkey_parse(
                    wally_get_secp_context(),
                    &pubkey,
                    _root_pubkey_bytes[pubkey_idx],
                    ROOT_PUBKEY_SIZE)) {
                Abort("Invalid root pubkey");
            }

            if (secp256k1_ecdsa_verify(ctx, &sig, msg32, &pubkey)) {
                matches_a_root_pubkey = true;
                break;
            }
        }
        if (!matches_a_root_pubkey) {
            screen_print_debug("setting certificate\nfailed: sig", 0);
            result = ERR_INVALID_INPUT;
            break;
        }

        screen_print_debug("setting certificate...", 0);
        if (!memory_set_attestation_certificate(
                attestation_device_pubkey, certificate, root_pubkey_identifier)) {
            screen_print_debug("setting certificate\nfailed: write", 0);
            result = ERR_FAILED;
            break;
        }
        screen_print_debug("DONE", 0);
        break;
    case OP_SC_ROLLKEYS:
        if (!securechip_reset_keys()) {
            screen_print_debug("resetting securechip keys: failed", 0);
            result = ERR_FAILED;
            break;
        }
        screen_print_debug("resetting securechip keys: success", 100);
        if (!securechip_u2f_counter_set(0)) {
            screen_print_debug("reset u2f counter", 0);
            result = ERR_FAILED;
            break;
        }
        screen_print_debug("reset u2f counter: success", 0);
        break;
    case OP_REBOOT:
        _reset_mcu();
        break;
    case OP_BLE_RESULT:
        if (memory_get_platform() == MEMORY_PLATFORM_BITBOX02_PLUS) {
            output[2] = _ble_result;
            out_len++;
        } else {
            result = ERR_UNKNOWN_COMMAND;
        }
        break;
    default:
        screen_sprintf_debug(1000, "unknown command: 0x%x", input[0]);
        result = ERR_UNKNOWN_COMMAND;
        break;
    }
    output[1] = result; // error code
    *output_len = out_len;
}

static void _free(uint8_t** buf)
{
    free(*buf);
    *buf = NULL;
}

static uint8_t _ble_firmware_checksum(const uint8_t* buf, size_t buf_len)
{
    uint8_t res = 0;
    for (size_t i = 0; i < buf_len; ++i) {
        res ^= buf[i];
    }
    return res;
}

static ble_error_code_t _verify_ble(const uint8_t* expected_ble_fw_hash, uint8_t expected_checksum)
{
    // We don't need to double-check the metadata, `memory_spi_get_active_ble_firmware()` and the
    // subsequent checks cover it (the FW uses the same function to fetch the active FW).

    uint8_t* __attribute__((__cleanup__(_free))) flashed_ble_fw = NULL;
    size_t flashed_ble_fw_size = 0;
    uint8_t flashed_ble_fw_checksum = 0;
    if (!memory_spi_get_active_ble_firmware(
            &flashed_ble_fw, &flashed_ble_fw_size, &flashed_ble_fw_checksum)) {
        screen_print_debug("_setup_ble: get firmware failed", 0);
        return BLE_ERR_READ_FW;
    }
    uint8_t flashed_ble_fw_hash[32] = {0};
    if (wally_sha256(
            flashed_ble_fw,
            flashed_ble_fw_size,
            flashed_ble_fw_hash,
            sizeof(flashed_ble_fw_hash)) != WALLY_OK) {
        Abort("_setup_ble: wally_sha256 failed");
    }
    if (flashed_ble_fw_size != da14531_firmware_size()) {
        screen_print_debug("_setup_ble: size check failed", 0);
        return BLE_ERR_FW_SIZE_MISMATCH;
    }
    if (flashed_ble_fw_checksum != expected_checksum) {
        screen_print_debug("_setup_ble: checksum mismatch", 0);
        return BLE_ERR_FW_CHECKSUM_MISMATCH;
    }
    if (!MEMEQ(expected_ble_fw_hash, flashed_ble_fw_hash, 32)) {
        screen_print_debug("_setup_ble: hash check failed", 0);
        return BLE_ERR_FW_MISMATCH;
    }

    return BLE_OK;
}

// TODO: call this as part of an API endpoint?
static ble_error_code_t _setup_ble(void)
{
    if (da14531_firmware_size() > MEMORY_SPI_BLE_FIRMWARE_MAX_SIZE) {
        return BLE_ERR_FW_TOO_LARGE;
    }

    uint8_t checksum = _ble_firmware_checksum(da14531_firmware_start(), da14531_firmware_size());

    // Compute FW hash.
    uint8_t ble_fw_hash[32] = {0};
    if (wally_sha256(
            da14531_firmware_start(), da14531_firmware_size(), ble_fw_hash, sizeof(ble_fw_hash)) !=
        WALLY_OK) {
        Abort("_setup_ble: wally_sha256 failed");
    }

    if (!MEMEQ(ble_fw_hash, _allowed_ble_fw_hash, 32)) {
        return BLE_ERR_FW_NOT_ALLOWED;
    }

    // BLE already setup, no need to repeat it. This saves a lot of time when repeating the
    // factorysetup of a device, as then we can skip the time-consuming chip erase below.
    if (_verify_ble(ble_fw_hash, checksum) == BLE_OK) {
        screen_print_debug("Skipping BLE setup.\nAlready done.", 0);
        return BLE_OK;
    }

    spi_mem_protected_area_unlock();

    // Erase chip.
    screen_print_debug("Erasing chip", 0);
    int32_t erased_sectors = spi_mem_smart_erase();
    if (erased_sectors == -1) {
        return BLE_ERR_SPI_ERASE;
    }
    util_log("spi mem: erased %ld sectors", (long)erased_sectors);

    // Write FW
    screen_print_debug("Writing BLE fw", 0);
    if (!spi_mem_write(
            MEMORY_SPI_BLE_FIRMWARE_1_ADDR, da14531_firmware_start(), da14531_firmware_size())) {
        screen_print_debug("Writing BLE fw failed", 0);
        return BLE_ERR_FLASH_FW;
    }

    memory_ble_metadata_t metadata;
    memory_get_ble_metadata(&metadata);

    memcpy(metadata.allowed_firmware_hash, ble_fw_hash, 32);
    metadata.active_index = 0;
    metadata.firmware_sizes[0] = (uint16_t)da14531_firmware_size();
    metadata.firmware_checksums[0] = checksum;
    if (!memory_set_ble_metadata(&metadata)) {
        screen_print_debug("_setup_ble: set metadata failed", 0);
        return BLE_ERR_SET_METADATA;
    }

    // Read back FW and re-compute and check hash.
    ble_error_code_t status = _verify_ble(ble_fw_hash, checksum);
    if (status != BLE_OK) {
        screen_print_debug("_setup_ble: failed to verify new firmware", 0);
        return status;
    }

    // Boot the chip
    // protocol_init will reset the chip so it asks for the firmware.
    da14531_protocol_init();
    uint8_t uart_read_buf[1024];
    uint16_t uart_read_buf_len = 0;
    uint8_t uart_write_buf[1024];
    struct ringbuffer uart_write_queue;
    ringbuffer_init(&uart_write_queue, uart_write_buf, sizeof(uart_write_buf));
    // If the BLE chip already was successfully booted, for example by running the factory-setup
    // once already and not power cycled, we need to ask for something to get a uart frame back.
    // Therefore we schedule a "get connection state".
    da14531_get_connection_state(&uart_write_queue);
    int32_t timeout = 1000000;
    while (timeout-- > 0) {
        uart_poll(uart_read_buf, sizeof(uart_read_buf), &uart_read_buf_len, &uart_write_queue);
        struct da14531_protocol_frame* frame =
            da14531_protocol_poll(uart_read_buf, &uart_read_buf_len, NULL, &uart_write_queue);
        if (frame) {
            // We have successfully booted the chip, the BLE chips firmware sent its first request
            return BLE_OK;
        }
    }
    screen_print_debug("Failed to check BLE chip status", 0);
    return BLE_ERR_NOT_BOOTED;
}

int main(void)
{
    init_mcu();
    system_init();
    platform_init();
    __stack_chk_guard = common_stack_chk_guard();
    screen_init();
    screen_splash();
    common_main();

    {
        // Set to re-enter bootloader again, otherwise we are stuck with this
        // firmware forever.
        auto_enter_t auto_enter = {
            .value = sectrue_u8,
        };
        upside_down_t upside_down = {
            .value = false,
        };
        if (!memory_bootloader_set_flags(auto_enter, upside_down)) {
            // Not much we can do here.
        }
    }

    screen_print_debug("READY", 0);

    if (memory_get_platform() == MEMORY_PLATFORM_BITBOX02_PLUS) {
        _ble_result = _setup_ble();
    }

    uint8_t msg_read[BUFFER_SIZE_DOWN] = {0};
    size_t len_read;
    uint8_t out[BUFFER_SIZE_UP];
    size_t out_len;

    while (1) {
        if (_rtt_receive(msg_read, &len_read)) {
            _api_msg(msg_read, len_read, out, &out_len);
            // screen_print_debug_hex(msg_read, len_read, 5000);
            _rtt_send(out, out_len);
        }
    }

    while (1);
}
